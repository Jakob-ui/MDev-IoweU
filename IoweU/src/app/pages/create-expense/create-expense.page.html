<ion-content [fullscreen]="true">
  <div id="container" class="container">
    <h3>Neue Ausgaben</h3>
    <div class="separator"></div>

    <!-- Beschreibung -->
    <div class="section">
      <div class="amount-row">
        <div class="Beschreibung">
          <span class="input-label">Ausgabe</span>
          <ion-item class="input-item">
            <ion-input
              type="text"
              placeholder="Beschreibung"
              maxlength="30"
              [(ngModel)]="expense.description"
            ></ion-input>
            <ion-note slot="end">{{ expense.description.length || 0 }}/30</ion-note>
          </ion-item>
        </div>

        <div class="Kategorie">
          <span class="input-label">Kategorie</span>
          <ion-item class="input-item" (click)="toggleDropdown()">
            <ion-label>
              <div class="selected-category">
                <ion-icon
                  [name]="selectedCategory?.icon"
                  class="category-icon"
                  id="category-icon-label"
                ></ion-icon>
              </div>
            </ion-label>
          </ion-item>

          <div *ngIf="dropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let category of categories"
                (click)="selectCategory(category)"
              >
                <ion-icon
                  [name]="category.icon"
                  class="category-icon"
                ></ion-icon>
                <ion-label>{{ category.name }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>

        <div class="invoice-upload">
          <span class="input-label">Rechnung</span>
          <ion-item class="input-item">
            <label class="upload-label">
              <ion-icon name="add-outline" class="upload-icon"></ion-icon>
              <input
                type="file"
                accept="image/*"
                (change)="onInvoiceUpload($event)"
                hidden
              />
            </label>
          </ion-item>
        </div>
      </div>
    </div>

    <!-- Betrag und Bezahlt von -->
    <div class="section">
      <div class="amount-row">
        <div class="betrag">
          <span class="input-label">Betrag</span>
          <ion-item class="input-item">
            <ion-input
              type="number"
              placeholder="0,00"
              [(ngModel)]="expense.totalAmount"
              (ionInput)="onTotalAmountChange()"
              step="0.01"
            >
            </ion-input>
          </ion-item>
        </div>
        <div class="Währung">
          <span class="input-label">Währung</span>
          <ion-item class="input-item" (click)="toggleCurrencyDropdown()">
            <ion-label>
              <div class="selected-currency">
                <span class="currency-label">{{ selectedCurrency || 'Währung' }}</span>
              </div>
            </ion-label>
          </ion-item>
        
          <div *ngIf="currencyDropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let currency of currencies"
                (click)="selectCurrency(currency)"
              >
                <ion-label>{{ currency }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="amount-row">
        <div class="paid-by">
          <span class="input-label">bezahlt von</span>
          <ion-item class="input-item" (click)="togglePaidByDropdown()">
            <ion-label>
              <div class="selected-paid-by">
                <span class="paid-by-label">
                  {{ selectedPaidBy?.username || 'bezahlt von' }}
                </span>
              </div>
            </ion-label>
          </ion-item>
        
          <div *ngIf="paidByDropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let groupMember of groupMembers"
                (click)="selectPaidBy(groupMember)"
              >
                <div
                  class="member-info"
                  [ngStyle]="{
                    'background-color': 'var(--member-color-background-' + groupMember.uid + ')',
                    'border-color': 'var(--member-color-' + groupMember.uid + ')'
                  }"
                >
                  <div
                    class="profile-placeholder"
                    [ngStyle]="{
                      'background-color': 'var(--member-color-' + groupMember.uid + ')',
                      'border-color': 'var(--member-color-' + groupMember.uid + ')'
                    }"
                  ></div>
                  <span class="member-name">{{ groupMember.username }}</span>
                </div>
              </ion-item>
            </ion-list>
          </div>
        </div>

        <div class="date">
          <span class="input-label">Datum</span>
          <ion-item class="input-item">
            <ion-input
              [(ngModel)]="expense.date"
              [readonly]="true"
              [placeholder]="expense.date"
              (click)="openDatePicker()"
            ></ion-input>
          </ion-item>
        </div>

        <div class="wiederholung">
          <span class="input-label">Wiederholung</span>
          <ion-item class="input-item" (click)="toggleRepeatDropdown()">
            <ion-label>
              <div class="selected-repeat">
                <span class="repeat-label">{{ selectedRepeat || 'Wiederholung' }}</span>
              </div>
            </ion-label>
          </ion-item>
        
          <div *ngIf="repeatDropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let repeatOption of repeatOptions"
                (click)="selectRepeat(repeatOption)"
              >
                <ion-label>{{ repeatOption }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>
      </div>
    </div>

    <!-- Aufteilung -->
    <div class="section">
      <div class="amount-row">
        <div class="split-type">
          <span class="input-label">Aufteilung</span>
          <ion-item class="input-item" (click)="toggleSplitTypeDropdown()">
            <ion-label>
              <div class="selected-split-type">
                <span class="split-type-label">{{ selectedSplitType || 'Aufteilung' }}</span>
              </div>
            </ion-label>
          </ion-item>
        
          <div *ngIf="splitTypeDropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let splitOption of splitTypeOptions"
                (click)="selectSplitType(splitOption)"
              >
                <ion-label>{{ splitOption.label }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>
        <div class="split-by">
          <span class="input-label">Teilen durch</span>
          <ion-item class="input-item" (click)="toggleSplitByDropdown()">
            <ion-label>
              <div class="selected-split-by">
                <span class="split-by-label">{{ selectedSplitBy || 'Teilen durch' }}</span>
              </div>
            </ion-label>
          </ion-item>
        
          <div *ngIf="splitByDropdownOpen" class="custom-dropdown">
            <ion-list>
              <ion-item
                class="dropDownFelder"
                button
                *ngFor="let splitOption of splitOptions"
                (click)="selectSplitBy(splitOption)"
              >
                <ion-label>{{ splitOption }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
        </div>
      </div>
    </div>

    <!-- Mitglieder -->
    <div class="section" id="member-section">
      <div
        class="member-list"
        *ngFor="let groupMember of groupMembers; let i = index"
      >
        <div class="member-list-input">
          <div
            class="member-info"
            [ngStyle]="{
                'background-color': 'var(--member-color-background-' + groupMember.uid + ')',
                'border-color': 'var(--member-color-' + groupMember.uid + ')'
             }"
          >
            <div
              class="profile-placeholder"
              [ngStyle]="{
              'background-color': 'var(--member-color-' + groupMember.uid + ')',
              'border-color': 'var(--member-color-' + groupMember.uid + ')'
            }"
            ></div>
            <span class="member-name">{{ groupMember.username }}</span>
          </div>
          <div
            *ngIf="expense.splitType === 'produkte'"
            class="toggle-arrow"
            (click)="toggleProducts(groupMember.uid)"
          >
            <ion-icon
              [src]="productInputs[groupMember.uid] ? 'assets/icon/ionicons/ios-arrow-down.svg' : 'assets/icon/ionicons/ios-arrow-up.svg'"
            >
            </ion-icon>
          </div>
          <div class="right-container">
            <!-- <div class="input-field" *ngIf="expense.splitType === 'anteile'">
              <ion-select
                [(ngModel)]="expense.splitType"
                interface="popover"
                (ngModelChange)="onSplitByChange()"
              >
                <ion-select-option
                  class="custom-select-option"
                  value="anteile"
                  [(ngModel)]="splitValue[groupMember.uid]"
                  >1/2x</ion-select-option
                >
                <ion-select-option
                  class="custom-select-option"
                  value="prozent"
                  [(ngModel)]="splitValue[groupMember.uid]"
                  >1/4x</ion-select-option
                >
                <ion-select-option
                  class="custom-select-option"
                  value="produkte"
                  [(ngModel)]="splitValue[groupMember.uid]"
                  >1/8x</ion-select-option
                ></ion-select
              >
            </div>-->

            <div class="input-field" *ngIf="expense.splitType === 'prozent'">
              <ion-input
                type="number"
                placeholder="%"
                [(ngModel)]="splitValue[groupMember.uid]"
                (ionInput)="calculateSplitByPercentage()"
              ></ion-input>
            </div>

            <div class="input-field">
              <ion-input
                type="number"
                placeholder="0,00"
                [(ngModel)]="amountToPay[groupMember.uid]"
                (ionInput)="onAmountToPayChange()"
                [readonly]="expense.splitBy === 'alle'"
                step="0.01"
              ></ion-input>
            </div>
          </div>
        </div>

        <div
          *ngIf="productInputs[groupMember.uid]"
          class="product-input-fields"
        >
          <div
            class="product-list"
            *ngIf="productInputs[groupMember.uid].products.length"
          >
            <ul>
              <li
                *ngFor="let product of productInputs[groupMember.uid].products"
              >
                <div class="left-container">
                  <span class="product-quantity"
                    >{{ product.quantity }} {{ product.unit }}</span
                  >
                  <span class="product">{{ product.productname }}</span>
                </div>
                <ion-badge class="product-price"
                  >{{ product.price | currency: 'EUR' }}</ion-badge
                >
                <ion-icon
                  class="delete-icon"
                  [src]="'assets/icon/ionicons/ios-close.svg'"
                  (click)="removeProduct(product)"
                >
                </ion-icon>
              </li>
            </ul>
          </div>
          <div class="product-input">
            <ion-input
              [(ngModel)]="productInputs[groupMember.uid].input.quantity"
              placeholder="Menge"
              type="number"
            >
            </ion-input>
            <ion-input
              [(ngModel)]="productInputs[groupMember.uid].input.unit"
              placeholder="Einheit"
            >
            </ion-input>
            <ion-input
              [(ngModel)]="productInputs[groupMember.uid].input.productname"
              placeholder="Produktname"
            >
            </ion-input>
            <ion-input
              [(ngModel)]="productInputs[groupMember.uid].input.price"
              (ngModelChange)="updateAmountToPayForProducts()"
              placeholder="Preis"
              type="number"
            >
            </ion-input>
            <ion-icon
              class="edit-button"
              (click)="addProduct(groupMember.uid)"
              [src]="productInputs ? 'assets/icon/ionicons/ios-add.svg' : 'assets/icon/ionicons/ios-add.svg'">
            </ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="button-row">
      <ion-button class="main-button" (click)="cancel()">Abbrechen</ion-button>
      <ion-button class="main-button" (click)="saveExpense()" [disabled]="false"
        >Speichern</ion-button
      >
    </div>
    <div>{{error}}</div>
  </div>

  <!-- Datepicker Modal -->
  <ion-datetime
    class="datepicker"
    presentation="date"
    [formatOptions]="{
      month: 'short',
      year: 'numeric',
      day: '2-digit'
    }"
    *ngIf="isDatePickerOpen"
    [(ngModel)]="expense.date"
    (ionChange)="onDateChange($event)"
    (ionCancel)="closeDatePicker()"
  >
  </ion-datetime>
</ion-content>
